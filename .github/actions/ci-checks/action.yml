inputs:
  check:
    required: true
  token:
    required: true

runs:
  using: composite
  steps:
    - if: ${{ contains(fromJSON('["changelog", "copyright", "sync"]'), inputs.check) }}
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 0
    - name: Restore the cache
      uses: ./.github/actions/ci-cache
    - run: ./scripts/setup.sh
      shell: bash
    - if: ${{ inputs.check == 'copyright' }}
      run: ./scripts/ci-copyright.sh
      shell: bash
    - if: ${{ inputs.check == 'changelog' }}
      run: ./scripts/ci-changelog.sh
      shell: bash
    - if: ${{ inputs.check == 'textreview' }}
      run: cargo xtask textreview
      shell: bash
    - if: ${{ inputs.check == 'sync' }}
      run: ./scripts/sync.sh
      shell: bash
    - if: ${{ inputs.check == 'publish' }}
      run: ./scripts/publish.sh --dry-run
      shell: bash
    - if: ${{ inputs.check == 'markdown' }}
      run: ./scripts/wrapper.sh mdl -g -s markdownlint.rb .
      shell: bash
    - if: ${{ inputs.check == 'taplo' }}
      run: ./scripts/ci-taplo.sh
      shell: bash
    - if: ${{ inputs.check == 'applets' }}
      run: ./scripts/ci-applets.sh
      shell: bash
    - if: ${{ inputs.check == 'runners' }}
      run: ./scripts/ci-runners.sh
      shell: bash
    - if: ${{ startsWith(inputs.check, 'tests-') }}
      run: ./scripts/ci-tests.sh $(sed s/tests-// <<< ${{ inputs.check }}) 11
      shell: bash
    - if: ${{ startsWith(inputs.check, 'hw-host-') }}
      run: SHARDING="$(sed s/hw-host-// <<< ${{ inputs.check }}) 2" ./scripts/hwci.sh host
      shell: bash
    - if: ${{ inputs.check == 'book' }}
      run: ./scripts/ci-book.sh
      shell: bash
    - if: ${{ inputs.check == 'artifacts' }}
      run: ./scripts/artifacts.sh --cleanup
      shell: bash
    - if: ${{ inputs.check == 'footprint' }}
      name: Compute footprint
      uses: ./.github/actions/ci-footprint
      with:
        token: ${{ inputs.token }}
    - run: git diff --exit-code
      shell: bash
    - run: '[ -z "$(git status -s | tee /dev/stderr)" ]'
      shell: bash
