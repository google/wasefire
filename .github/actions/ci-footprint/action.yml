inputs:
  upload:
    required: true
  token:
    required: true

runs:
  using: composite
  steps:
    - run: ./scripts/footprint.sh
      shell: bash
    - run: mv footprint.toml footprint-${{ github.event_name }}.toml
      shell: bash
    - if: github.event_name == 'push' && inputs.upload == 'true'
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: footprint
        path: footprint-push.toml
    - if: github.event_name == 'pull_request'
      id: main-run
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      with:
        script: |
          const { data } = await github.rest.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'ci.yml',
            branch: 'main',
            event: 'push',
            head_sha: '${{ github.event.pull_request.base.sha }}',
          });
          return data.workflow_runs[0]?.id ?? 0;
    - if: github.event_name == 'pull_request'
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      with:
        name: footprint
        github-token: ${{ inputs.token }}
        run-id: ${{ steps.main-run.outputs.result }}
      continue-on-error: true
    - if: github.event_name == 'pull_request'
      run: cargo xtask footprint "$GITHUB_STEP_SUMMARY"
      shell: bash
    - run: rm footprint-*.toml
      shell: bash
